<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FamilyQuest - Pełna Wersja</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      min-height: 100vh;
      color: #fff;
    }
    
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .app-container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 1rem;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      font-size: 1rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #7C3AED, #A78BFA);
      color: white;
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
    }
    
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6); }
    
    .btn-success { background: linear-gradient(135deg, #12B76A, #34D399); color: white; }
    .btn-danger { background: linear-gradient(135deg, #F97066, #FDA4A0); color: white; }
    .btn-secondary { background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); }
    .btn-ghost { background: rgba(255, 255, 255, 0.08); color: white; border: 1px solid rgba(255, 255, 255, 0.25); }
    
    .input, .textarea, .select {
      width: 100%;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      color: white;
      font-family: inherit;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    .input::placeholder { color: rgba(255, 255, 255, 0.6); }
    .input:focus, .textarea:focus, .select:focus {
      outline: none;
      border-color: #FEC84B;
      background: rgba(255, 255, 255, 0.25);
    }
    
    .task-item {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.25);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .task-item:hover { transform: translateX(5px); border-color: #FEC84B; }
    .task-item.completed { background: rgba(254, 200, 75, 0.2); border-color: #FEC84B; }
    .task-item.approved { background: rgba(18, 183, 106, 0.2); border-color: #12B76A; }
    
    .checkbox {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 1.5rem;
    }
    
    .task-item.completed .checkbox { background: #FEC84B; border-color: #FEC84B; }
    .task-item.approved .checkbox { background: #12B76A; border-color: #12B76A; }
    
    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .badge-min { background: #7C3AED; color: white; }
    .badge-plus { background: #F97316; color: white; }
    .badge-weekly { background: #3B82F6; color: white; }
    .badge-points { background: #FEC84B; color: #0F172A; }
    .badge-pending { background: rgba(254, 200, 75, 0.2); color: #FEC84B; border: 1px solid #FEC84B; }
    
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.2);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
    }
    
    .stat-value { font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0; }
    .stat-label { font-size: 0.9rem; opacity: 0.8; }
    
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.15rem;
      padding: 0.25rem;
      border-radius: 0.5rem;
      font-weight: 700;
      border: 2px solid transparent;
    }
    
    .calendar-day-status {
      font-size: 1.05rem;
      line-height: 1;
    }
    
    .calendar-day-date {
      font-size: 0.72rem;
      line-height: 1;
      opacity: 0.9;
      letter-spacing: 0.02em;
    }
    
    .calendar-day.passed { background: rgba(18, 183, 106, 0.3); border-color: #12B76A; }
    .calendar-day.failed { background: rgba(249, 112, 102, 0.3); border-color: #F97066; }
    .calendar-day.na { background: rgba(148, 163, 184, 0.2); border-color: rgba(148, 163, 184, 0.4); }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    
    .modal-content {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 1rem;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      font-weight: 600;
    }
    
    .tab.active { background: rgba(255, 255, 255, 0.3); color: white; }
    .tab:hover { background: rgba(255, 255, 255, 0.2); }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      font-size: 1.2rem;
    }
    
    .error {
      background: rgba(249, 112, 102, 0.2);
      border: 2px solid #F97066;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .success {
      background: rgba(18, 183, 106, 0.2);
      border: 2px solid #12B76A;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      animation: confettiFall 3s linear forwards;
      pointer-events: none;
      z-index: 9999;
    }
    
    @keyframes confettiFall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    .child-avatar { font-size: 5rem; margin: 1rem 0; }
    .child-card { text-align: center; padding: 2rem; cursor: pointer; transition: all 0.3s; }
    .child-card:hover { transform: scale(1.05); }
    
    .progress-bar {
      height: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #12B76A, #34D399);
      transition: width 1s ease;
      box-shadow: 0 0 10px rgba(18, 183, 106, 0.6);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      opacity: 0.6;
    }
    
    .top-status {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    
    .network-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.14);
    }
    
    .network-badge.offline {
      background: rgba(249, 112, 102, 0.2);
      border-color: #F97066;
    }
    
    .network-badge.syncing {
      background: rgba(254, 200, 75, 0.2);
      border-color: #FEC84B;
      color: #FEC84B;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    .history-day {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.8rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    
    .reward-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1rem;
    }
    
    .reward-overlay-content {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(254, 200, 75, 0.8);
      backdrop-filter: blur(20px);
      border-radius: 1.2rem;
      max-width: 520px;
      width: 100%;
      padding: 2rem;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .glass-card { padding: 1rem; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    
    const AUTH_TOKEN_KEY = 'fq_auth_token';
    const API_BASE_KEY = 'fq_api_base';
    
    const normalizeApiBase = (value) => {
      const raw = String(value || '').trim();
      if (!raw) return '';
      return raw.endsWith('/') ? raw.slice(0, -1) : raw;
    };
    
    const getApiBase = () => {
      const manualBase = normalizeApiBase(localStorage.getItem(API_BASE_KEY));
      if (manualBase) return manualBase;
      
      const host = window.location.hostname;
      const isLocalHost = host === 'localhost' || host === '127.0.0.1';
      if (isLocalHost && window.location.port !== '3010') {
        return 'http://localhost:3010';
      }
      return '';
    };
    
    const buildApiUrl = (path) => {
      if (/^https?:\/\//i.test(path)) return path;
      const base = getApiBase();
      return `${base}${path}`;
    };
    
    const getAuthToken = () => localStorage.getItem(AUTH_TOKEN_KEY);
    const setAuthToken = (token) => localStorage.setItem(AUTH_TOKEN_KEY, token);
    const clearAuthToken = () => localStorage.removeItem(AUTH_TOKEN_KEY);
    
    const apiRequest = async (path, options = {}, withAuth = true) => {
      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      
      if (withAuth) {
        const token = getAuthToken();
        if (token) {
          headers.Authorization = `Bearer ${token}`;
        }
      }
      
      const response = await fetch(buildApiUrl(path), {
        ...options,
        headers,
        body: options.body !== undefined ? JSON.stringify(options.body) : undefined
      });
      
      let data = null;
      try {
        data = await response.json();
      } catch (e) {
        data = null;
      }
      
      if (!response.ok) {
        const message = data?.error || `HTTP ${response.status}`;
        const error = new Error(message);
        error.status = response.status;
        throw error;
      }
      
      return data;
    };
    
    // Storage API via backend
    const useStorage = () => {
      const get = async (key) => {
        try {
          const result = await apiRequest(`/api/storage/get/${encodeURIComponent(key)}`);
          return result?.value ?? null;
        } catch (e) {
          console.error('Storage get error:', e);
          return null;
        }
      };
      
      const set = async (key, value) => {
        try {
          await apiRequest(`/api/storage/set/${encodeURIComponent(key)}`, {
            method: 'POST',
            body: { value }
          });
          return true;
        } catch (e) {
          console.error('Storage set error:', e);
          return false;
        }
      };
      
      const list = async (prefix) => {
        try {
          const result = await apiRequest(`/api/storage/list?prefix=${encodeURIComponent(prefix || '')}`);
          return result?.keys || [];
        } catch (e) {
          console.error('Storage list error:', e);
          return [];
        }
      };
      
      return { get, set, list };
    };

    const POINTS_PER_PASSED_DAY = 10;
    const IDEAL_WEEK_BONUS = 20;
    const HISTORY_DAYS = 30;
    const DAY_NAMES = ['Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob', 'Ndz'];
    const CHILD_AVATARS = [
      '👧', '👦', '🧒', '👶', '🧑', '👱‍♀️', '👱‍♂️', '🧑‍🦱', '🧑‍🦰', '🧑‍🦳',
      '🦊', '🐼', '🦁', '🐯', '🐨', '🐸', '🐵', '🐶', '🐱', '🐰',
      '🦄', '🐙', '🦕', '🦖', '🦋', '⚽', '🏀', '🎮', '🎨', '🎵',
    ];
    const TASK_TEMPLATES = [
      { id: 'tpl-bed', title: 'Pościel łóżko', tier: 'MIN', points: 2, description: 'Rano po wstaniu' },
      { id: 'tpl-teeth', title: 'Umyj zęby', tier: 'MIN', points: 1, description: 'Rano i wieczorem' },
      { id: 'tpl-homework', title: 'Odrób lekcje', tier: 'MIN', points: 4, description: 'Po szkole' },
      { id: 'tpl-room', title: 'Posprzątaj pokój', tier: 'PLUS', points: 5, description: '15 minut porządków' },
      { id: 'tpl-reading', title: 'Czytanie 20 minut', tier: 'PLUS', points: 4, description: 'Dowolna książka' },
      { id: 'tpl-weekly-sport', title: 'Trening tygodniowy', tier: 'WEEKLY', points: 12, description: 'Min. 1 trening' },
    ];
    const isValidChildAccessCode = (value) => /^\d{4}$/.test(String(value || ''));
    const findAvailableChildAccessCode = (children, preferredCode = null, excludeChildId = null) => {
      const used = new Set(
        (children || [])
          .filter(c => c.id !== excludeChildId && isValidChildAccessCode(c.accessCode))
          .map(c => c.accessCode),
      );
      if (isValidChildAccessCode(preferredCode) && !used.has(preferredCode)) return preferredCode;
      for (let i = 0; i <= 9999; i++) {
        const code = String(i).padStart(4, '0');
        if (!used.has(code)) return code;
      }
      return null;
    };
    
    const toDateString = (date = new Date()) => date.toISOString().split('T')[0];
    const getWeekStart = (dateInput) => {
      const date = new Date(dateInput);
      const day = date.getDay();
      const diff = day === 0 ? -6 : 1 - day;
      date.setDate(date.getDate() + diff);
      return toDateString(date);
    };

    // Main App
    const App = () => {
      const storage = useStorage();
      
      const [user, setUser] = useState(null);
      const [children, setChildren] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [completions, setCompletions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [streaks, setStreaks] = useState({});
      const [points, setPoints] = useState({});
      const [rewardUnlocks, setRewardUnlocks] = useState([]);
      const [familyGoal, setFamilyGoal] = useState({ title: 'Cel rodzinny', target: 500, mode: 'points' });
      const [auditLogs, setAuditLogs] = useState([]);
      const [dayPointGrants, setDayPointGrants] = useState({});
      const [weekBonusGrants, setWeekBonusGrants] = useState({});
      const [parentUsers, setParentUsers] = useState([]);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [syncing, setSyncing] = useState(false);
      const [showRewardOverlay, setShowRewardOverlay] = useState(null);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState('login'); // login, childSelect, child, parent
      const [selectedChild, setSelectedChild] = useState(null);
      const [parentTab, setParentTab] = useState('approvals');
      const [showModal, setShowModal] = useState(null);
      const [editingChild, setEditingChild] = useState(null);
      const [approvalFilterChildId, setApprovalFilterChildId] = useState('ALL');
      const [approvalFilterDate, setApprovalFilterDate] = useState('');
      
      const resetFamilyData = () => {
        setChildren([]);
        setTasks([]);
        setCompletions([]);
        setRewards([]);
        setStreaks({});
        setPoints({});
        setRewardUnlocks([]);
        setFamilyGoal({ title: 'Cel rodzinny', target: 500, mode: 'points' });
        setAuditLogs([]);
        setDayPointGrants({});
        setWeekBonusGrants({});
        setParentUsers([]);
        setShowRewardOverlay(null);
        setSelectedChild(null);
        setParentTab('approvals');
        setShowModal(null);
        setEditingChild(null);
        setApprovalFilterChildId('ALL');
        setApprovalFilterDate('');
      };
      
      useEffect(() => {
        const goOnline = () => setIsOnline(true);
        const goOffline = () => setIsOnline(false);
        window.addEventListener('online', goOnline);
        window.addEventListener('offline', goOffline);
        return () => {
          window.removeEventListener('online', goOnline);
          window.removeEventListener('offline', goOffline);
        };
      }, []);
      
      const addAuditLog = useCallback((action, entityType, entityId, details = {}) => {
        const entry = {
          id: `audit-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
          userId: user?.id || null,
          action,
          entityType,
          entityId,
          details,
          createdAt: new Date().toISOString(),
        };
        setAuditLogs(prev => [entry, ...prev].slice(0, 500));
      }, [user?.id]);
      
      // Initialize data
      useEffect(() => {
        loadData();
      }, []);
      
      const loadData = async () => {
        setLoading(true);
        
        try {
          const token = getAuthToken();
          if (!token) {
            setUser(null);
            resetFamilyData();
            setView('login');
            return;
          }
          
          const session = await apiRequest('/api/auth/me');
          setUser(session.user);
          
          const [
            savedChildren,
            savedTasks,
            savedCompletions,
            savedRewards,
            savedStreaks,
            savedPoints,
            savedRewardUnlocks,
            savedFamilyGoal,
            savedAuditLogs,
            savedDayPointGrants,
            savedWeekBonusGrants,
          ] = await Promise.all([
            storage.get('children'),
            storage.get('tasks'),
            storage.get('completions'),
            storage.get('rewards'),
            storage.get('streaks'),
            storage.get('points'),
            storage.get('rewardUnlocks'),
            storage.get('familyGoal'),
            storage.get('auditLogs'),
            storage.get('dayPointGrants'),
            storage.get('weekBonusGrants'),
          ]);

          const rawChildren = savedChildren || [];
          const loadedChildren = rawChildren.map(child => ({ ...child }));
          loadedChildren.forEach((child) => {
            if (!isValidChildAccessCode(child.accessCode)) {
              child.accessCode = findAvailableChildAccessCode(loadedChildren, null, child.id);
            }
          });
          setChildren(loadedChildren);
          setTasks(savedTasks || []);
          setCompletions(savedCompletions || []);
          setRewards(savedRewards || []);
          setStreaks(savedStreaks || {});
          setPoints(savedPoints || {});
          setRewardUnlocks(savedRewardUnlocks || []);
          setFamilyGoal(savedFamilyGoal || { title: 'Cel rodzinny', target: 500, mode: 'points' });
          setAuditLogs(savedAuditLogs || []);
          setDayPointGrants(savedDayPointGrants || {});
          setWeekBonusGrants(savedWeekBonusGrants || {});

          if (session.user?.role === 'CHILD') {
            const ownChild = loadedChildren.find(c => c.id === session.user.childId && !c.archived);
            if (!ownChild) {
              throw new Error('Profil dziecka nie istnieje lub jest zarchiwizowany');
            }
            setSelectedChild(ownChild);
            setView('child');
          } else {
            setSelectedChild(null);
            setView('childSelect');
          }
          
          try {
            const parentUsersResponse = await apiRequest('/api/auth/parents');
            setParentUsers(parentUsersResponse.users || []);
          } catch (parentError) {
            console.warn('Could not load parent users:', parentError.message);
            setParentUsers([]);
          }
        } catch (e) {
          console.error('Load data error:', e);
          clearAuthToken();
          setUser(null);
          resetFamilyData();
          setView('login');
        } finally {
          setLoading(false);
        }
      };
      
      const saveData = async () => {
        try {
          setSyncing(true);
          await Promise.all([
            storage.set('children', children),
            storage.set('tasks', tasks),
            storage.set('completions', completions),
            storage.set('rewards', rewards),
            storage.set('streaks', streaks),
            storage.set('points', points),
            storage.set('rewardUnlocks', rewardUnlocks),
            storage.set('familyGoal', familyGoal),
            storage.set('auditLogs', auditLogs),
            storage.set('dayPointGrants', dayPointGrants),
            storage.set('weekBonusGrants', weekBonusGrants),
          ]);
        } catch (e) {
          console.error('Save data error:', e);
        } finally {
          setSyncing(false);
        }
      };
      
      useEffect(() => {
        if (!loading && user) saveData();
      }, [
        loading,
        user,
        children,
        tasks,
        completions,
        rewards,
        streaks,
        points,
        rewardUnlocks,
        familyGoal,
        auditLogs,
        dayPointGrants,
        weekBonusGrants,
      ]);
      
      // Business Logic
      const getDateString = (date = new Date()) => toDateString(date);
      const activeChildren = children.filter(c => !c.archived);
      
      const evaluateDay = (childId, date) => {
        const child = children.find(c => c.id === childId);
        if (!child) return 'NOT_ACTIVE';
        
        const dayOfWeek = new Date(date).getDay();
        const adjustedDay = dayOfWeek === 0 ? 7 : dayOfWeek;
        
        if (!child.activeDays.includes(adjustedDay)) return 'NOT_ACTIVE';
        
        const minTasks = tasks.filter(t => t.childId === childId && t.tier === 'MIN' && t.active);
        if (minTasks.length === 0) return 'PASSED';
        
        const approvedCount = minTasks.filter(task => {
          return completions.some(c => 
            c.taskId === task.id && 
            c.date === date && 
            c.approvedByParent
          );
        }).length;
        
        return approvedCount === minTasks.length ? 'PASSED' : 'FAILED';
      };
      
      const evaluateWeek = (childId, weekStart) => {
        let activeDays = 0;
        let passedDays = 0;
        for (let i = 0; i < 7; i++) {
          const date = new Date(weekStart);
          date.setDate(date.getDate() + i);
          const dateStr = getDateString(date);
          const status = evaluateDay(childId, dateStr);
          if (status === 'NOT_ACTIVE') continue;
          activeDays += 1;
          if (status === 'PASSED') {
            passedDays += 1;
          }
        }
        if (activeDays === 0) return 'NO_ACTIVE_DAYS';
        return passedDays === activeDays ? 'IDEAL' : 'NOT_IDEAL';
      };
      
      useEffect(() => {
        const next = {};
        const today = new Date();
        const minStart = new Date(today);
        minStart.setDate(today.getDate() - HISTORY_DAYS);
        
        children
          .filter(child => !child.archived)
          .forEach(child => {
            const createdDate = child.createdAt ? new Date(child.createdAt) : minStart;
            const startDate = createdDate > minStart ? createdDate : minStart;
            
            let current = 0;
            let best = 0;
            let idealWeeksCount = 0;
            let idealWeeksInRow = 0;
            let rollingIdealRow = 0;
            let lastEvaluatedDate = null;
            
            const weekMap = {};
            const cursor = new Date(startDate);
            while (cursor <= today) {
              const dateStr = getDateString(cursor);
              const status = evaluateDay(child.id, dateStr);
              if (status === 'PASSED') {
                current += 1;
                if (current > best) best = current;
                lastEvaluatedDate = dateStr;
              } else if (status === 'FAILED') {
                current = 0;
                lastEvaluatedDate = dateStr;
              }
              
              const weekStart = getWeekStart(dateStr);
              if (!weekMap[weekStart]) {
                weekMap[weekStart] = evaluateWeek(child.id, weekStart);
              }
              
              cursor.setDate(cursor.getDate() + 1);
            }
            
            Object.keys(weekMap).sort().forEach(weekStart => {
              const status = weekMap[weekStart];
              if (status === 'NO_ACTIVE_DAYS') return;
              if (status === 'IDEAL') {
                idealWeeksCount += 1;
                rollingIdealRow += 1;
              } else {
                rollingIdealRow = 0;
              }
              idealWeeksInRow = rollingIdealRow;
            });
            
            next[child.id] = {
              current,
              best,
              lastEvaluatedDate,
              idealWeeksCount,
              idealWeeksInRow,
            };
          });
        
        setStreaks(next);
      }, [children, tasks, completions]);
      
      const grantPoints = (childId, amount) => {
        setPoints(prev => {
          const currentPoints = prev[childId] || 0;
          return { ...prev, [childId]: currentPoints + amount };
        });
      };
      
      const getDayPointKey = (childId, date) => `${childId}:${date}`;
      const getWeekPointKey = (childId, weekStart) => `${childId}:${weekStart}`;
      
      const grantDayPointsIfNeeded = (childId, date) => {
        const key = getDayPointKey(childId, date);
        if (dayPointGrants[key]) return;
        setDayPointGrants(prev => ({ ...prev, [key]: true }));
        grantPoints(childId, POINTS_PER_PASSED_DAY);
        addAuditLog('GRANT_DAY_POINTS', 'DAY', key, { childId, date, points: POINTS_PER_PASSED_DAY });
      };
      
      const grantWeekBonusIfNeeded = (childId, date) => {
        const weekStart = getWeekStart(date);
        const weekStatus = evaluateWeek(childId, weekStart);
        if (weekStatus !== 'IDEAL') return;
        const key = getWeekPointKey(childId, weekStart);
        if (weekBonusGrants[key]) return;
        setWeekBonusGrants(prev => ({ ...prev, [key]: true }));
        grantPoints(childId, IDEAL_WEEK_BONUS);
        addAuditLog('GRANT_WEEK_BONUS', 'WEEK', key, { childId, weekStart, points: IDEAL_WEEK_BONUS });
      };
      
      const checkRewards = (childId) => {
        const childPoints = points[childId] || 0;
        const childStreak = streaks[childId] || { current: 0, idealWeeksInRow: 0 };
        const now = new Date().toISOString();
        
        rewards.forEach(reward => {
          if (reward.active === false) return;
          const already = rewardUnlocks.find(r => r.childId === childId && r.rewardId === reward.id);
          if (already) return;
          
          const pointsOk = !reward.requiredPoints || childPoints >= reward.requiredPoints;
          const streakOk = !reward.requiredStreak || childStreak.current >= reward.requiredStreak;
          const idealOk = !reward.requiredIdealWeeks || childStreak.idealWeeksInRow >= reward.requiredIdealWeeks;
          
          if (pointsOk && streakOk && idealOk) {
            const unlock = {
              id: `unlock-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
              childId,
              rewardId: reward.id,
              unlockedAt: now,
              claimedAt: null,
              shownAt: null,
            };
            setRewardUnlocks(prev => [unlock, ...prev]);
            setShowRewardOverlay({ childId, reward });
            addAuditLog('UNLOCK_REWARD', 'REWARD', reward.id, { childId });
          }
        });
      };
      
      useEffect(() => {
        activeChildren.forEach(child => checkRewards(child.id));
      }, [points, streaks, rewards, children]);
      
      // Login
      const handleLogin = async (email, password) => {
        try {
          const result = await apiRequest(
            '/api/auth/login',
            {
              method: 'POST',
              body: { email, password },
            },
            false,
          );
          
          setAuthToken(result.token);
          await loadData();
          return { success: true };
        } catch (e) {
          return { success: false, error: e.message || 'Nieprawidłowy email lub hasło' };
        }
      };
      
      const handleRegister = async ({ email, password, pinCode, familyName }) => {
        try {
          const result = await apiRequest(
            '/api/auth/register',
            {
              method: 'POST',
              body: { email, password, pinCode, familyName },
            },
            false,
          );
          
          setAuthToken(result.token);
          await loadData();
          return { success: true };
        } catch (e) {
          return { success: false, error: e.message || 'Nie udało się utworzyć konta' };
        }
      };

      const handleChildLogin = async (accessCode) => {
        try {
          const result = await apiRequest(
            '/api/auth/login-child',
            {
              method: 'POST',
              body: { accessCode },
            },
            false,
          );
          setAuthToken(result.token);
          await loadData();
          return { success: true };
        } catch (e) {
          return { success: false, error: e.message || 'Nieprawidłowy kod dziecka' };
        }
      };

      const handleForgotPassword = async (email) => {
        try {
          const result = await apiRequest(
            '/api/auth/forgot-password',
            {
              method: 'POST',
              body: { email },
            },
            false,
          );
          return {
            success: true,
            message: result?.message || 'Jeśli konto istnieje, instrukcja resetu została wysłana.',
            debugResetToken: result?.debugResetToken || null,
          };
        } catch (e) {
          return { success: false, error: e.message || 'Nie udało się uruchomić resetu hasła' };
        }
      };

      const handleResetPasswordByToken = async (token, newPassword) => {
        try {
          await apiRequest(
            '/api/auth/reset-password/token',
            {
              method: 'POST',
              body: { token, newPassword },
            },
            false,
          );
          return { success: true, message: 'Hasło zostało zmienione. Możesz się zalogować.' };
        } catch (e) {
          return { success: false, error: e.message || 'Nie udało się zresetować hasła' };
        }
      };
      
      const handleLogout = () => {
        clearAuthToken();
        setUser(null);
        resetFamilyData();
        setView('login');
      };
      
      // Child selection
      const selectChild = (child) => {
        setSelectedChild(child);
        setView('child');
      };
      
      const enterParentMode = () => {
        if (user?.role === 'CHILD') return;
        setView('parent');
      };
      
      // Task completion
      const toggleTask = (taskId) => {
        const today = getDateString();
        const existing = completions.find(c => 
          c.taskId === taskId && c.date === today && c.childId === selectedChild.id
        );
        
        if (existing) {
          existing.doneByChild = !existing.doneByChild;
          if (!existing.doneByChild) {
            existing.approvedByParent = false;
            existing.approvedAt = null;
          }
          setCompletions([...completions]);
          addAuditLog('TOGGLE_TASK', 'COMPLETION', existing.id, {
            childId: selectedChild.id,
            taskId,
            doneByChild: existing.doneByChild,
          });
        } else {
          const newCompletion = {
            id: `comp-${Date.now()}`,
            taskId,
            childId: selectedChild.id,
            date: today,
            doneByChild: true,
            approvedByParent: false
          };
          setCompletions([...completions, newCompletion]);
          addAuditLog('TOGGLE_TASK', 'COMPLETION', newCompletion.id, {
            childId: selectedChild.id,
            taskId,
            doneByChild: true,
          });
        }
      };
      
      // Parent approve
      const approveTask = (completion) => {
        const previousStatus = evaluateDay(completion.childId, completion.date);
        const comp = completions.find(c => c.id === completion.id);
        if (comp) {
          comp.approvedByParent = true;
          comp.approvedAt = new Date().toISOString();
          comp.rejectedAt = null;
          comp.rejectedByParent = false;
          
          // Grant points
          const task = tasks.find(t => t.id === comp.taskId);
          if (task && task.points > 0) {
            grantPoints(comp.childId, task.points);
          }
          
          const nextStatus = evaluateDay(comp.childId, comp.date);
          if (previousStatus !== 'PASSED' && nextStatus === 'PASSED') {
            grantDayPointsIfNeeded(comp.childId, comp.date);
            grantWeekBonusIfNeeded(comp.childId, comp.date);
            checkRewards(comp.childId);
          }
          
          setCompletions([...completions]);
          addAuditLog('APPROVE_TASK', 'COMPLETION', comp.id, {
            childId: comp.childId,
            taskId: comp.taskId,
            date: comp.date,
          });
          
          // Show confetti
          showConfetti();
        }
      };
      
      const rejectTask = (completion) => {
        const comp = completions.find(c => c.id === completion.id);
        if (!comp) return;
        comp.doneByChild = false;
        comp.approvedByParent = false;
        comp.rejectedByParent = true;
        comp.rejectedAt = new Date().toISOString();
        setCompletions([...completions]);
        addAuditLog('REJECT_TASK', 'COMPLETION', comp.id, {
          childId: comp.childId,
          taskId: comp.taskId,
          date: comp.date,
        });
      };
      
      const approveAllPending = (list = null) => {
        const queue = [...(list || completions.filter(c => c.doneByChild && !c.approvedByParent))];
        queue.forEach(item => approveTask(item));
      };
      
      const showConfetti = () => {
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = '-10px';
            confetti.style.background = ['#FF6B9D', '#FEC84B', '#12B76A', '#7C3AED', '#F97316'][Math.floor(Math.random() * 5)];
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 3000);
          }, i * 30);
        }
      };
      
      // Add child
      const addChild = async (name, avatar, activeDays) => {
        const accessCode = findAvailableChildAccessCode(children);
        if (!accessCode) {
          alert('Brak wolnych kodów dostępu dla dzieci');
          return;
        }
        const newChild = {
          id: `child-${Date.now()}`,
          name,
          avatar,
          activeDays,
          accessCode,
          archived: false,
          createdAt: new Date().toISOString()
        };
        setChildren([...children, newChild]);
        setStreaks({ ...streaks, [newChild.id]: { current: 0, best: 0, idealWeeksCount: 0, idealWeeksInRow: 0 } });
        setPoints({ ...points, [newChild.id]: 0 });
        addAuditLog('ADD_CHILD', 'CHILD', newChild.id, { name, activeDays });
        setShowModal(null);
      };
      
      // Add task
      const addTask = async (childId, title, tier, points, description) => {
        const newTask = {
          id: `task-${Date.now()}`,
          childId,
          title,
          tier,
          points: points || 0,
          description,
          active: true,
          createdAt: new Date().toISOString()
        };
        setTasks([...tasks, newTask]);
        addAuditLog('ADD_TASK', 'TASK', newTask.id, { childId, tier, points: newTask.points });
        setShowModal(null);
      };
      
      // Add reward
      const addReward = async (title, description, requiredPoints, requiredStreak, requiredIdealWeeks) => {
        const newReward = {
          id: `reward-${Date.now()}`,
          title,
          description,
          requiredPoints,
          requiredStreak,
          requiredIdealWeeks,
          active: true,
          createdAt: new Date().toISOString()
        };
        setRewards([...rewards, newReward]);
        addAuditLog('ADD_REWARD', 'REWARD', newReward.id, {
          requiredPoints,
          requiredStreak,
          requiredIdealWeeks,
        });
        setShowModal(null);
      };
      
      const updateChild = (childId, updates) => {
        setChildren(prev =>
          prev.map(child => (child.id === childId ? { ...child, ...updates, updatedAt: new Date().toISOString() } : child)),
        );
        addAuditLog('UPDATE_CHILD', 'CHILD', childId, updates);
      };
      
      const archiveChild = (childId) => {
        updateChild(childId, { archived: true });
      };
      
      const updateTask = (taskId, updates) => {
        setTasks(prev =>
          prev.map(task => (task.id === taskId ? { ...task, ...updates, updatedAt: new Date().toISOString() } : task)),
        );
        addAuditLog('UPDATE_TASK', 'TASK', taskId, updates);
      };
      
      const archiveTask = (taskId) => {
        updateTask(taskId, { active: false });
      };
      
      const claimReward = (unlockId) => {
        setRewardUnlocks(prev =>
          prev.map(u => (u.id === unlockId ? { ...u, claimedAt: new Date().toISOString() } : u)),
        );
        addAuditLog('CLAIM_REWARD', 'REWARD_UNLOCK', unlockId);
      };
      
      const updateFamilyGoal = (updates) => {
        setFamilyGoal(prev => ({ ...prev, ...updates }));
        addAuditLog('UPDATE_FAMILY_GOAL', 'FAMILY_GOAL', 'family-goal', updates);
      };
      
      const loadParentUsers = async () => {
        const response = await apiRequest('/api/auth/parents');
        setParentUsers(response.users || []);
      };
      
      const addParentUser = async ({ email, password, pinCode }) => {
        await apiRequest('/api/auth/parents', {
          method: 'POST',
          body: { email, password, pinCode },
        });
        await loadParentUsers();
        addAuditLog('ADD_PARENT_USER', 'USER', email);
      };
      
      const setParentUserActive = async (userId, active) => {
        await apiRequest(`/api/auth/parents/${userId}/active`, {
          method: 'PUT',
          body: { active },
        });
        await loadParentUsers();
        addAuditLog(active ? 'ACTIVATE_USER' : 'DEACTIVATE_USER', 'USER', userId, { active });
      };
      
      const changeMyPin = async (pinCode) => {
        const response = await apiRequest('/api/auth/pin', {
          method: 'PUT',
          body: { pinCode },
        });
        setUser(response.user);
        addAuditLog('CHANGE_PIN', 'USER', response.user.id);
      };
      
      const changeMyPassword = async (currentPassword, newPassword) => {
        await apiRequest('/api/auth/password', {
          method: 'PUT',
          body: { currentPassword, newPassword },
        });
        addAuditLog('CHANGE_PASSWORD', 'USER', user?.id || 'self');
      };
      
      const resetParentPassword = async (userId, newPassword) => {
        await apiRequest('/api/auth/password/reset', {
          method: 'PUT',
          body: { userId, newPassword },
        });
        addAuditLog('RESET_PASSWORD', 'USER', userId);
      };
      
      const exportFamilyBackup = () => {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          data: {
            children,
            tasks,
            completions,
            rewards,
            streaks,
            points,
            rewardUnlocks,
            familyGoal,
            auditLogs,
            dayPointGrants,
            weekBonusGrants,
          },
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `familyquest-backup-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };
      
      const importFamilyBackup = (jsonText) => {
        const parsed = JSON.parse(jsonText);
        const data = parsed?.data || {};
        setChildren(data.children || []);
        setTasks(data.tasks || []);
        setCompletions(data.completions || []);
        setRewards(data.rewards || []);
        setStreaks(data.streaks || {});
        setPoints(data.points || {});
        setRewardUnlocks(data.rewardUnlocks || []);
        setFamilyGoal(data.familyGoal || { title: 'Cel rodzinny', target: 500, mode: 'points' });
        setAuditLogs(data.auditLogs || []);
        setDayPointGrants(data.dayPointGrants || {});
        setWeekBonusGrants(data.weekBonusGrants || {});
        addAuditLog('IMPORT_BACKUP', 'BACKUP', 'family');
      };
      
      if (loading) {
        return (
            <div className="app-container">
            <div className="glass-card loading">
              🏆 Ładowanie FamilyQuest...
            </div>
          </div>
        );
      }
      
      // Login View
      if (view === 'login') {
        return (
          <LoginView
            onLogin={handleLogin}
            onRegister={handleRegister}
            onChildLogin={handleChildLogin}
            onForgotPassword={handleForgotPassword}
            onResetPassword={handleResetPasswordByToken}
          />
        );
      }
      
      // Child Selection View
      if (view === 'childSelect') {
        return (
          <ChildSelectionView 
            children={activeChildren}
            onSelectChild={selectChild}
            onParentMode={enterParentMode}
            onLogout={handleLogout}
            parentPin={user?.pinCode}
          />
        );
      }
      
      // Child Dashboard View
      if (view === 'child' && selectedChild) {
        const today = getDateString();
        const childTasks = tasks.filter(t => t.childId === selectedChild.id && t.active);
        const todayCompletions = completions.filter(c => c.childId === selectedChild.id && c.date === today);
        const childStreak = streaks[selectedChild.id] || { current: 0, best: 0 };
        const childPoints = points[selectedChild.id] || 0;
        const dayStatus = evaluateDay(selectedChild.id, today);
        
        // Get last 14 days
        const last14Days = [];
        for (let i = 0; i < 14; i++) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = getDateString(date);
          const status = evaluateDay(selectedChild.id, dateStr);
          last14Days.unshift({ date: dateStr, status });
        }
        
        return (
          <>
          <div className="app-container">
            <div className="top-status">
              <div className={`network-badge ${isOnline ? '' : 'offline'}`}>
                {isOnline ? '🟢 Online' : '🔴 Offline'}
              </div>
              {syncing && <div className="network-badge syncing">⏳ Synchronizacja...</div>}
            </div>
            <div className="glass-card">
              <div className="header">
                <button className="btn btn-secondary" onClick={() => setView('childSelect')}>← Powrót</button>
                <h1>{selectedChild.avatar} {selectedChild.name}</h1>
                <div style={{display: 'flex', gap: '1rem'}}>
                  <div className="badge badge-points">⚡ {childPoints} pkt</div>
                  <div className="badge badge-min">🔥 {childStreak.current} dni</div>
                </div>
              </div>
              
              <div className="glass-card" style={{marginBottom: '1rem'}}>
                <h3>Status dnia: {
                  dayStatus === 'PASSED' ? '✅ ZALICZONY' :
                  dayStatus === 'FAILED' ? '❌ NIE ZALICZONY' :
                  '⊘ NIE AKTYWNY'
                }</h3>
                <p style={{opacity: 0.7, marginTop: '0.5rem'}}>
                  Punkty i zaliczenie wymagają akceptacji rodzica
                </p>
              </div>
              
              <div className="grid grid-2" style={{marginBottom: '1.5rem'}}>
                <div className="stat-card">
                  <div className="stat-label">Aktualna passa</div>
                  <div className="stat-value">{childStreak.current}</div>
                  <div className="stat-label">dni z rzędu</div>
                </div>
                <div className="stat-card">
                  <div className="stat-label">Najlepsza passa</div>
                  <div className="stat-value">{childStreak.best}</div>
                  <div className="stat-label">rekord</div>
                </div>
              </div>
              
              <div className="glass-card" style={{marginBottom: '1.5rem'}}>
                <h3 style={{marginBottom: '1rem'}}>Ostatnie 14 dni</h3>
                <div className="calendar">
                  {last14Days.map((day, i) => {
                    const [, month, dayOfMonth] = day.date.split('-');
                    const formattedDate = `${dayOfMonth}.${month}`;
                    return (
                      <div key={i} className={`calendar-day ${day.status.toLowerCase().replace('_', '')}`} title={day.date}>
                        <span className="calendar-day-status">
                          {day.status === 'PASSED' ? '✓' : day.status === 'FAILED' ? '✗' : '−'}
                        </span>
                        <span className="calendar-day-date">{formattedDate}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
              
              <h2 style={{marginBottom: '1rem'}}>Zadania dzisiaj</h2>
              
              <h3 style={{marginTop: '1.5rem', marginBottom: '0.5rem'}}>📋 MINIMUM (wymagane)</h3>
              {childTasks.filter(t => t.tier === 'MIN').map(task => {
                const completion = todayCompletions.find(c => c.taskId === task.id);
                const isDone = completion?.doneByChild;
                const isApproved = completion?.approvedByParent;
                const isPendingApproval = isDone && !isApproved;
                
                return (
                  <div 
                    key={task.id} 
                    className={`task-item ${isDone ? 'completed' : ''} ${isApproved ? 'approved' : ''}`}
                    onClick={() => toggleTask(task.id)}
                  >
                    <div className="checkbox">{isApproved ? '✓' : isDone ? '⏳' : ''}</div>
                    <div style={{flex: 1}}>
                      <div style={{fontWeight: 600}}>{task.title}</div>
                      {task.description && <div style={{fontSize: '0.9rem', opacity: 0.7}}>{task.description}</div>}
                      {isPendingApproval && (
                        <div className="badge badge-pending" style={{marginTop: '0.35rem', width: 'fit-content'}}>
                          Czeka na zatwierdzenie rodzica
                        </div>
                      )}
                    </div>
                    {isApproved && <div className="badge badge-min">Zatwierdzone</div>}
                  </div>
                );
              })}
              
              <h3 style={{marginTop: '1.5rem', marginBottom: '0.5rem'}}>⭐ BONUS (dodatkowe punkty)</h3>
              {childTasks.filter(t => t.tier === 'PLUS').map(task => {
                const completion = todayCompletions.find(c => c.taskId === task.id);
                const isDone = completion?.doneByChild;
                const isApproved = completion?.approvedByParent;
                const isPendingApproval = isDone && !isApproved;
                
                return (
                  <div 
                    key={task.id} 
                    className={`task-item ${isDone ? 'completed' : ''} ${isApproved ? 'approved' : ''}`}
                    onClick={() => toggleTask(task.id)}
                  >
                    <div className="checkbox">{isApproved ? '✓' : isDone ? '⏳' : ''}</div>
                    <div style={{flex: 1}}>
                      <div style={{fontWeight: 600}}>{task.title}</div>
                      {isPendingApproval && (
                        <div className="badge badge-pending" style={{marginTop: '0.35rem', width: 'fit-content'}}>
                          Czeka na zatwierdzenie rodzica
                        </div>
                      )}
                    </div>
                    {task.points > 0 && <div className="badge badge-points">+{task.points} pkt</div>}
                  </div>
                );
              })}
              
              {childTasks.filter(t => t.tier === 'WEEKLY').length > 0 && (
                <>
                  <h3 style={{marginTop: '1.5rem', marginBottom: '0.5rem'}}>📅 TYGODNIOWE</h3>
                  {childTasks.filter(t => t.tier === 'WEEKLY').map(task => {
                    const completion = todayCompletions.find(c => c.taskId === task.id);
                    const isDone = completion?.doneByChild;
                    const isApproved = completion?.approvedByParent;
                    const isPendingApproval = isDone && !isApproved;
                    
                    return (
                      <div 
                        key={task.id} 
                        className={`task-item ${isDone ? 'completed' : ''} ${isApproved ? 'approved' : ''}`}
                        onClick={() => toggleTask(task.id)}
                      >
                        <div className="checkbox">{isApproved ? '✓' : isDone ? '⏳' : ''}</div>
                        <div style={{flex: 1}}>
                          <div style={{fontWeight: 600}}>{task.title}</div>
                          {isPendingApproval && (
                            <div className="badge badge-pending" style={{marginTop: '0.35rem', width: 'fit-content'}}>
                              Czeka na zatwierdzenie rodzica
                            </div>
                          )}
                        </div>
                        {task.points > 0 && <div className="badge badge-points">+{task.points} pkt</div>}
                      </div>
                    );
                  })}
                </>
              )}
            </div>
            <FamilyGoalWidget
              familyGoal={familyGoal}
              children={activeChildren}
              points={points}
              evaluateDay={evaluateDay}
              getDateString={getDateString}
            />
          </div>
          {showRewardOverlay && showRewardOverlay.childId === selectedChild.id && (
            <RewardOverlay
              reward={showRewardOverlay.reward}
              onClose={() => {
                setRewardUnlocks(prev =>
                  prev.map(u =>
                    u.childId === showRewardOverlay.childId &&
                    u.rewardId === showRewardOverlay.reward.id &&
                    !u.shownAt
                      ? { ...u, shownAt: new Date().toISOString() }
                      : u,
                  ),
                );
                setShowRewardOverlay(null);
              }}
            />
          )}
          </>
        );
      }
      
      // Parent Dashboard View
      if (view === 'parent') {
        const pendingApprovals = completions.filter(c => c.doneByChild && !c.approvedByParent);
        const filteredPendingApprovals = pendingApprovals.filter(comp => {
          const childOk = approvalFilterChildId === 'ALL' || comp.childId === approvalFilterChildId;
          const dateOk = !approvalFilterDate || comp.date === approvalFilterDate;
          return childOk && dateOk;
        });
        
        return (
          <>
          <div className="app-container">
            <div className="top-status">
              <div className={`network-badge ${isOnline ? '' : 'offline'}`}>
                {isOnline ? '🟢 Online' : '🔴 Offline'}
              </div>
              {syncing && <div className="network-badge syncing">⏳ Synchronizacja...</div>}
            </div>
            <div className="glass-card">
              <div className="header">
                <button className="btn btn-secondary" onClick={() => setView('childSelect')}>← Powrót</button>
                <h1>🔐 Panel Rodzica</h1>
                <button className="btn btn-danger" onClick={handleLogout}>Wyloguj</button>
              </div>
              
              <div className="tabs">
                <button className={`tab ${parentTab === 'approvals' ? 'active' : ''}`} onClick={() => setParentTab('approvals')}>
                  Do zatwierdzenia ({pendingApprovals.length})
                </button>
                <button className={`tab ${parentTab === 'children' ? 'active' : ''}`} onClick={() => setParentTab('children')}>
                  Dzieci ({activeChildren.length})
                </button>
                <button className={`tab ${parentTab === 'tasks' ? 'active' : ''}`} onClick={() => setParentTab('tasks')}>
                  Zadania ({tasks.length})
                </button>
                <button className={`tab ${parentTab === 'rewards' ? 'active' : ''}`} onClick={() => setParentTab('rewards')}>
                  Nagrody ({rewards.length})
                </button>
                <button className={`tab ${parentTab === 'stats' ? 'active' : ''}`} onClick={() => setParentTab('stats')}>
                  Statystyki
                </button>
                <button className={`tab ${parentTab === 'settings' ? 'active' : ''}`} onClick={() => setParentTab('settings')}>
                  Ustawienia
                </button>
              </div>
              
              {parentTab === 'approvals' && (
                <>
                  <div className="header">
                    <h2>Zadania do zatwierdzenia</h2>
                    {filteredPendingApprovals.length > 0 && (
                      <button className="btn btn-primary" onClick={() => approveAllPending(filteredPendingApprovals)}>
                        ✅ Zatwierdź wg filtra ({filteredPendingApprovals.length})
                      </button>
                    )}
                  </div>

                  <div className="glass-card" style={{marginBottom: '1rem'}}>
                    <div className="grid grid-3">
                      <div>
                        <label style={{display: 'block', marginBottom: '0.4rem', opacity: 0.8}}>Dziecko</label>
                        <select
                          className="select"
                          value={approvalFilterChildId}
                          onChange={e => setApprovalFilterChildId(e.target.value)}
                        >
                          <option value="ALL">Wszystkie</option>
                          {activeChildren.map(child => (
                            <option key={child.id} value={child.id}>
                              {child.avatar} {child.name}
                            </option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label style={{display: 'block', marginBottom: '0.4rem', opacity: 0.8}}>Data</label>
                        <input
                          className="input"
                          type="date"
                          value={approvalFilterDate}
                          onChange={e => setApprovalFilterDate(e.target.value)}
                        />
                      </div>
                      <div style={{display: 'flex', alignItems: 'end'}}>
                        <button
                          className="btn btn-secondary"
                          style={{width: '100%'}}
                          onClick={() => {
                            setApprovalFilterChildId('ALL');
                            setApprovalFilterDate('');
                          }}
                        >
                          Wyczyść filtry
                        </button>
                      </div>
                    </div>
                  </div>

                  {filteredPendingApprovals.length === 0 ? (
                    <div className="empty-state">
                      <div style={{fontSize: '3rem'}}>✅</div>
                      <p>
                        {pendingApprovals.length === 0
                          ? 'Brak zadań do zatwierdzenia'
                          : 'Brak zadań pasujących do filtrów'}
                      </p>
                    </div>
                  ) : (
                    filteredPendingApprovals.map(comp => {
                      const task = tasks.find(t => t.id === comp.taskId);
                      const child = children.find(c => c.id === comp.childId);
                      if (!task || !child) return null;
                      
                      return (
                        <div key={comp.id} className="task-item">
                          <div style={{fontSize: '2rem'}}>{child.avatar}</div>
                          <div style={{flex: 1}}>
                            <div style={{fontWeight: 600}}>{task.title}</div>
                            <div style={{fontSize: '0.9rem', opacity: 0.7}}>
                              {child.name} • {comp.date}
                            </div>
                          </div>
                          <div className={`badge badge-${task.tier.toLowerCase()}`}>{task.tier}</div>
                          {task.points > 0 && <div className="badge badge-points">+{task.points} pkt</div>}
                          <button className="btn btn-success" onClick={() => approveTask(comp)} title="Zatwierdź zadanie">
                            ✅ Zatwierdź
                          </button>
                          <button className="btn btn-danger" onClick={() => rejectTask(comp)} title="Odrzuć zadanie">
                            ❌ Odrzuć
                          </button>
                        </div>
                      );
                    })
                  )}
                  
                  <div style={{marginTop: '1.5rem'}}>
                    <h3 style={{marginBottom: '0.75rem'}}>Historia ostatnich 7 dni</h3>
                    {activeChildren.length === 0 ? (
                      <div className="empty-state">Brak dzieci</div>
                    ) : (
                      activeChildren.map(child => {
                        const days = [];
                        for (let i = 0; i < 7; i++) {
                          const date = new Date();
                          date.setDate(date.getDate() - i);
                          const dateStr = getDateString(date);
                          const status = evaluateDay(child.id, dateStr);
                          const dayCompletions = completions.filter(c => c.childId === child.id && c.date === dateStr);
                          const approvedCount = dayCompletions.filter(c => c.approvedByParent).length;
                          const approvedTasks = dayCompletions
                            .filter(c => c.approvedByParent)
                            .map(c => {
                              const task = tasks.find(t => t.id === c.taskId);
                              return task ? `${task.title}${task.points ? ` (+${task.points})` : ''}` : null;
                            })
                            .filter(Boolean);
                          const dayPoints = dayCompletions.reduce((sum, comp) => {
                            const task = tasks.find(t => t.id === comp.taskId);
                            return sum + (comp.approvedByParent && task?.points ? task.points : 0);
                          }, 0);
                          days.push({ dateStr, status, approvedCount, dayPoints, approvedTasks });
                        }
                        return (
                          <div key={child.id} className="glass-card" style={{marginBottom: '1rem'}}>
                            <h4 style={{marginBottom: '0.75rem'}}>{child.avatar} {child.name}</h4>
                            {days.map(day => (
                              <div key={day.dateStr} className="history-day">
                                <div style={{display: 'flex', justifyContent: 'space-between', gap: '1rem'}}>
                                  <span>{day.dateStr}</span>
                                  <span>
                                    {day.status === 'PASSED' ? '✅ ZAL' : day.status === 'FAILED' ? '❌ NZ' : '⊘ N/A'}
                                  </span>
                                </div>
                                <div style={{fontSize: '0.85rem', opacity: 0.8, marginTop: '0.25rem'}}>
                                  Zatwierdzone: {day.approvedCount} • Punkty: {day.dayPoints}
                                </div>
                                {day.approvedTasks.length > 0 && (
                                  <div style={{fontSize: '0.8rem', opacity: 0.75, marginTop: '0.2rem'}}>
                                    {day.approvedTasks.join(' • ')}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        );
                      })
                    )}
                  </div>
                </>
              )}
              
              {parentTab === 'children' && (
                <>
                  <div className="header">
                    <h2>Zarządzanie dziećmi</h2>
                    <button className="btn btn-primary" onClick={() => setShowModal('addChild')}>
                      + Dodaj dziecko
                    </button>
                  </div>
                  
                  {activeChildren.length === 0 ? (
                    <div className="empty-state">
                      <div style={{fontSize: '3rem'}}>👨‍👩‍👧‍👦</div>
                      <p>Brak dzieci. Dodaj pierwsze dziecko!</p>
                    </div>
                  ) : (
                    <div className="grid grid-2">
                      {activeChildren.map(child => {
                        const childStreak = streaks[child.id] || { current: 0, best: 0 };
                        const childPoints = points[child.id] || 0;
                        const childTasks = tasks.filter(t => t.childId === child.id);
                        
                        return (
                          <div key={child.id} className="glass-card">
                            <div className="child-avatar">{child.avatar}</div>
                            <h3 style={{textAlign: 'center', marginBottom: '1rem'}}>{child.name}</h3>
                            <div className="grid grid-2" style={{marginBottom: '1rem'}}>
                              <div className="stat-card">
                                <div className="stat-value">{childPoints}</div>
                                <div className="stat-label">punktów</div>
                              </div>
                              <div className="stat-card">
                                <div className="stat-value">{childStreak.current}</div>
                                <div className="stat-label">passa</div>
                              </div>
                            </div>
                            <div style={{fontSize: '0.9rem', opacity: 0.7, textAlign: 'center'}}>
                              {childTasks.length} zadań • Dni aktywne: {child.activeDays.join(', ')}
                            </div>
                            <div style={{fontSize: '0.9rem', opacity: 0.85, textAlign: 'center', marginTop: '0.35rem'}}>
                              Kod dziecka: <strong>{child.accessCode || '----'}</strong>
                            </div>
                            <div style={{display: 'flex', gap: '0.5rem', marginTop: '1rem'}}>
                              <button
                                className="btn btn-secondary"
                                style={{flex: 1}}
                                onClick={() => setEditingChild(child)}
                              >
                                ✏️ Edytuj
                              </button>
                              <button
                                className="btn btn-danger"
                                style={{flex: 1}}
                                onClick={() => {
                                  if (confirm(`Archiwizować profil ${child.name}?`)) {
                                    archiveChild(child.id);
                                  }
                                }}
                              >
                                🗃️ Archiwizuj
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </>
              )}
              
              {parentTab === 'tasks' && (
                <>
                  <div className="header">
                    <h2>Zarządzanie zadaniami</h2>
                    <button className="btn btn-primary" onClick={() => setShowModal('addTask')}>
                      + Dodaj zadanie
                    </button>
                  </div>
                  
                  {tasks.length === 0 ? (
                    <div className="empty-state">
                      <div style={{fontSize: '3rem'}}>📝</div>
                      <p>Brak zadań. Dodaj pierwsze zadanie!</p>
                    </div>
                  ) : (
                    activeChildren.map(child => {
                      const childTasks = tasks.filter(t => t.childId === child.id && t.active !== false);
                      if (childTasks.length === 0) return null;
                      
                      return (
                        <div key={child.id} style={{marginBottom: '2rem'}}>
                          <h3 style={{marginBottom: '1rem'}}>{child.avatar} {child.name}</h3>
                          {childTasks.map(task => (
                            <div key={task.id} className="task-item">
                              <div style={{flex: 1}}>
                                <div style={{fontWeight: 600}}>{task.title}</div>
                                {task.description && (
                                  <div style={{fontSize: '0.9rem', opacity: 0.7}}>{task.description}</div>
                                )}
                              </div>
                              <div className={`badge badge-${task.tier.toLowerCase()}`}>{task.tier}</div>
                              {task.points > 0 && <div className="badge badge-points">+{task.points} pkt</div>}
                              <button
                                className="btn btn-secondary"
                                onClick={() => {
                                  const title = prompt('Nowy tytuł zadania:', task.title);
                                  if (!title) return;
                                  const tier = prompt('Typ zadania (MIN/PLUS/WEEKLY):', task.tier);
                                  if (!tier) return;
                                  const normalizedTier = tier.trim().toUpperCase();
                                  if (!['MIN', 'PLUS', 'WEEKLY'].includes(normalizedTier)) return;
                                  const pointsValue = prompt('Punkty za zadanie:', String(task.points || 0));
                                  const parsedPoints = parseInt(pointsValue || '0', 10);
                                  updateTask(task.id, {
                                    title: title.trim(),
                                    tier: normalizedTier,
                                    points: Number.isNaN(parsedPoints) ? 0 : parsedPoints,
                                  });
                                }}
                              >
                                ✏️
                              </button>
                              <button
                                className="btn btn-danger"
                                onClick={() => {
                                  if (confirm('Archiwizować zadanie?')) {
                                    archiveTask(task.id);
                                  }
                                }}
                              >
                                🗃️
                              </button>
                            </div>
                          ))}
                        </div>
                      );
                    })
                  )}
                </>
              )}
              
              {parentTab === 'rewards' && (
                <>
                  <div className="header">
                    <h2>Katalog nagród</h2>
                    <button className="btn btn-primary" onClick={() => setShowModal('addReward')}>
                      + Dodaj nagrodę
                    </button>
                  </div>
                  
                  {rewards.length === 0 ? (
                    <div className="empty-state">
                      <div style={{fontSize: '3rem'}}>🎁</div>
                      <p>Brak nagród. Dodaj pierwszą nagrodę!</p>
                    </div>
                  ) : (
                    rewards.map(reward => (
                      <div key={reward.id} className="task-item">
                        <div style={{fontSize: '2rem'}}>🎁</div>
                        <div style={{flex: 1}}>
                          <div style={{fontWeight: 600}}>{reward.title}</div>
                          <div style={{fontSize: '0.9rem', opacity: 0.7}}>{reward.description}</div>
                          <div style={{marginTop: '0.5rem', display: 'flex', gap: '0.5rem'}}>
                            {reward.requiredPoints && (
                              <div className="badge badge-points">{reward.requiredPoints} punktów</div>
                            )}
                            {reward.requiredStreak && (
                              <div className="badge badge-min">{reward.requiredStreak} dni passy</div>
                            )}
                            {reward.requiredIdealWeeks && (
                              <div className="badge badge-weekly">{reward.requiredIdealWeeks} idealnych tygodni</div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                  
                  <div className="glass-card" style={{marginTop: '1rem'}}>
                    <h3 style={{marginBottom: '0.75rem'}}>Odblokowane nagrody</h3>
                    {rewardUnlocks.length === 0 ? (
                      <div className="empty-state">Brak odblokowanych nagród</div>
                    ) : (
                      rewardUnlocks.map(unlock => {
                        const reward = rewards.find(r => r.id === unlock.rewardId);
                        const child = children.find(c => c.id === unlock.childId);
                        if (!reward || !child) return null;
                        return (
                          <div key={unlock.id} className="task-item">
                            <div style={{fontSize: '2rem'}}>🏅</div>
                            <div style={{flex: 1}}>
                              <div style={{fontWeight: 600}}>{reward.title}</div>
                              <div style={{fontSize: '0.85rem', opacity: 0.8}}>
                                {child.name} • odblokowano: {unlock.unlockedAt?.slice(0, 10)}
                              </div>
                              <div style={{fontSize: '0.8rem', opacity: 0.7}}>
                                {unlock.claimedAt ? `Wydano: ${unlock.claimedAt.slice(0, 10)}` : 'Oczekuje na wydanie'}
                              </div>
                            </div>
                            {!unlock.claimedAt && (
                              <button className="btn btn-success" onClick={() => claimReward(unlock.id)}>
                                ✅ Wydano
                              </button>
                            )}
                          </div>
                        );
                      })
                    )}
                  </div>
                </>
              )}
              
              {parentTab === 'stats' && (
                <>
                  <h2 style={{marginBottom: '1rem'}}>Statystyki rodziny</h2>
                  <div className="grid grid-3">
                    {activeChildren.map(child => {
                      const childStreak = streaks[child.id] || { current: 0, best: 0, idealWeeksCount: 0, idealWeeksInRow: 0 };
                      const childPoints = points[child.id] || 0;
                      const today = getDateString();
                      const status = evaluateDay(child.id, today);
                      
                      return (
                        <div key={child.id} className="glass-card">
                          <div className="child-avatar" style={{fontSize: '3rem'}}>{child.avatar}</div>
                          <h3 style={{textAlign: 'center', marginBottom: '1rem'}}>{child.name}</h3>
                          <div style={{marginBottom: '0.5rem'}}>
                            <div style={{fontSize: '0.9rem', opacity: 0.7}}>Status dzisiaj</div>
                            <div style={{fontSize: '1.2rem', fontWeight: 600}}>
                              {status === 'PASSED' ? '✅ Zaliczony' : 
                               status === 'FAILED' ? '❌ Niezaliczony' : 
                               '⊘ Nieaktywny'}
                            </div>
                          </div>
                          <div style={{marginBottom: '0.5rem'}}>
                            <div style={{fontSize: '0.9rem', opacity: 0.7}}>Punkty</div>
                            <div style={{fontSize: '2rem', fontWeight: 700}}>{childPoints}</div>
                          </div>
                          <div>
                            <div style={{fontSize: '0.9rem', opacity: 0.7}}>Passa</div>
                            <div style={{fontSize: '2rem', fontWeight: 700}}>{childStreak.current} dni</div>
                            <div style={{fontSize: '0.9rem', opacity: 0.7}}>Rekord: {childStreak.best}</div>
                            <div style={{fontSize: '0.9rem', opacity: 0.7}}>Idealne tygodnie: {childStreak.idealWeeksCount || 0}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  <div className="glass-card" style={{marginTop: '2rem'}}>
                    <h3 style={{marginBottom: '1rem'}}>📊 Ranking tygodniowy</h3>
                    {activeChildren.length === 0 ? (
                      <div className="empty-state">Brak dzieci</div>
                    ) : (
                      [...activeChildren]
                        .sort((a, b) => {
                          const aIdeal = streaks[a.id]?.idealWeeksInRow || 0;
                          const bIdeal = streaks[b.id]?.idealWeeksInRow || 0;
                          if (aIdeal !== bIdeal) return bIdeal - aIdeal;
                          const aStreak = streaks[a.id]?.current || 0;
                          const bStreak = streaks[b.id]?.current || 0;
                          if (aStreak !== bStreak) return bStreak - aStreak;
                          return (points[b.id] || 0) - (points[a.id] || 0);
                        })
                        .map((child, index) => {
                          const childStreak = streaks[child.id] || { current: 0, best: 0, idealWeeksInRow: 0 };
                          const childPoints = points[child.id] || 0;
                          
                          return (
                            <div key={child.id} className="task-item">
                              <div style={{fontSize: '2rem', fontWeight: 700, width: '50px', textAlign: 'center'}}>
                                {index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`}
                              </div>
                              <div style={{fontSize: '2rem'}}>{child.avatar}</div>
                              <div style={{flex: 1}}>
                                <div style={{fontWeight: 600}}>{child.name}</div>
                                <div style={{fontSize: '0.9rem', opacity: 0.7}}>
                                  Idealne tyg.: {childStreak.idealWeeksInRow || 0} • Passa: {childStreak.current} • {childPoints} pkt
                                </div>
                              </div>
                            </div>
                          );
                        })
                    )}
                  </div>
                </>
              )}
              
              {parentTab === 'settings' && (
                <>
                  <h2 style={{marginBottom: '1rem'}}>Ustawienia rodzica</h2>
                  <div className="settings-grid">
                    <SettingsSecurityPanel
                      user={user}
                      parentUsers={parentUsers}
                      onRefreshParents={loadParentUsers}
                      onAddParent={addParentUser}
                      onToggleParent={setParentUserActive}
                      onChangePin={changeMyPin}
                      onChangePassword={changeMyPassword}
                      onResetPassword={resetParentPassword}
                    />
                    <SettingsBackupPanel
                      familyGoal={familyGoal}
                      onFamilyGoalChange={updateFamilyGoal}
                      onExport={exportFamilyBackup}
                      onImport={importFamilyBackup}
                    />
                  </div>
                  
                  <div className="glass-card" style={{marginTop: '1rem'}}>
                    <h3 style={{marginBottom: '0.75rem'}}>Audit log (ostatnie zmiany)</h3>
                    {auditLogs.length === 0 ? (
                      <div className="empty-state">Brak wpisów audytu</div>
                    ) : (
                      auditLogs.slice(0, 25).map(log => (
                        <div key={log.id} className="history-day">
                          <div style={{display: 'flex', justifyContent: 'space-between', gap: '1rem'}}>
                            <strong>{log.action}</strong>
                            <span style={{opacity: 0.8}}>{(log.createdAt || '').replace('T', ' ').slice(0, 16)}</span>
                          </div>
                          <div style={{fontSize: '0.85rem', opacity: 0.8}}>
                            {log.entityType} • {log.entityId}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </>
              )}
            </div>
            
            <FamilyGoalWidget
              familyGoal={familyGoal}
              children={activeChildren}
              points={points}
              evaluateDay={evaluateDay}
              getDateString={getDateString}
            />
          </div>
          
          {showModal === 'addChild' && (
            <AddChildModal 
              onAdd={addChild} 
              onClose={() => setShowModal(null)} 
            />
          )}

          {editingChild && (
            <EditChildModal
              child={editingChild}
              siblings={children}
              onSave={(updates) => {
                updateChild(editingChild.id, updates);
                setEditingChild(null);
              }}
              onClose={() => setEditingChild(null)}
            />
          )}
          
          {showModal === 'addTask' && (
            <AddTaskModal 
              children={activeChildren}
              onAdd={addTask} 
              onClose={() => setShowModal(null)} 
            />
          )}
          
          {showModal === 'addReward' && (
            <AddRewardModal 
              onAdd={addReward} 
              onClose={() => setShowModal(null)} 
            />
          )}
          </>
        );
      }
      
      return null;
    };
    
    const RewardOverlay = ({ reward, onClose }) => {
      if (!reward) return null;
      return (
        <div className="reward-overlay" onClick={onClose}>
          <div className="reward-overlay-content" onClick={e => e.stopPropagation()}>
            <div style={{fontSize: '4rem', marginBottom: '0.5rem'}}>🎉</div>
            <h2 style={{marginBottom: '0.5rem'}}>Nowa nagroda odblokowana!</h2>
            <h3 style={{marginBottom: '0.5rem'}}>{reward.title}</h3>
            <p style={{opacity: 0.9, marginBottom: '1rem'}}>{reward.description}</p>
            <button className="btn btn-primary" onClick={onClose}>
              Super! 🚀
            </button>
          </div>
        </div>
      );
    };
    
    const FamilyGoalWidget = ({ familyGoal, children, points, evaluateDay, getDateString }) => {
      const today = getDateString();
      const totalPoints = children.reduce((sum, child) => sum + (points[child.id] || 0), 0);
      const totalPassedDays = children.reduce((sum, child) => {
        let passed = 0;
        for (let i = 0; i < HISTORY_DAYS; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const status = evaluateDay(child.id, getDateString(date));
          if (status === 'PASSED') passed += 1;
        }
        return sum + passed;
      }, 0);
      
      const mode = familyGoal?.mode || 'points';
      const currentValue = mode === 'passedDays' ? totalPassedDays : totalPoints;
      const target = Number(familyGoal?.target || 1);
      const progress = Math.max(0, Math.min(100, Math.round((currentValue / Math.max(target, 1)) * 100)));
      
      return (
        <div className="glass-card">
          <h3 style={{marginBottom: '0.5rem'}}>🎯 {familyGoal?.title || 'Cel rodzinny'}</h3>
          <div style={{fontSize: '0.9rem', opacity: 0.8}}>
            {mode === 'passedDays' ? 'Tryb: liczba zaliczonych dni' : 'Tryb: suma punktów rodziny'}
          </div>
          <div style={{marginTop: '0.5rem', fontWeight: 600}}>
            {currentValue} / {target}
          </div>
          <div className="progress-bar">
            <div className="progress-fill" style={{width: `${progress}%`}} />
          </div>
        </div>
      );
    };
    
    const SettingsSecurityPanel = ({
      user,
      parentUsers,
      onRefreshParents,
      onAddParent,
      onToggleParent,
      onChangePin,
      onChangePassword,
      onResetPassword,
    }) => {
      const [newParentEmail, setNewParentEmail] = useState('');
      const [newParentPassword, setNewParentPassword] = useState('');
      const [newParentPin, setNewParentPin] = useState('');
      const [pinCode, setPinCode] = useState('');
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [resetPasswordValue, setResetPasswordValue] = useState('');
      const [resetTarget, setResetTarget] = useState('');
      const [message, setMessage] = useState('');
      
      useEffect(() => {
        onRefreshParents();
      }, []);
      
      return (
        <div className="glass-card">
          <h3 style={{marginBottom: '0.75rem'}}>🔐 Konta i bezpieczeństwo</h3>
          {message && <div className="success">{message}</div>}
          
          <h4 style={{marginBottom: '0.5rem'}}>Dodaj konto rodzica (nieaktywne)</h4>
          <input className="input" placeholder="Email" value={newParentEmail} onChange={e => setNewParentEmail(e.target.value)} />
          <input className="input" placeholder="Hasło tymczasowe" type="password" value={newParentPassword} onChange={e => setNewParentPassword(e.target.value)} />
          <input className="input" placeholder="PIN (4 cyfry, opcjonalnie)" value={newParentPin} onChange={e => setNewParentPin(e.target.value.replace(/\D/g, '').slice(0, 4))} />
          <button
            className="btn btn-primary"
            style={{width: '100%', marginBottom: '1rem'}}
            onClick={async () => {
              try {
                await onAddParent({ email: newParentEmail, password: newParentPassword, pinCode: newParentPin || undefined });
                setMessage('Dodano konto rodzica. Czeka na aktywację.');
                setNewParentEmail('');
                setNewParentPassword('');
                setNewParentPin('');
              } catch (e) {
                setMessage(e.message);
              }
            }}
          >
            + Dodaj rodzica
          </button>
          
          <h4 style={{marginBottom: '0.5rem'}}>Użytkownicy rodzice</h4>
          {parentUsers.map(parent => (
            <div key={parent.id} className="history-day">
              <div style={{display: 'flex', justifyContent: 'space-between', gap: '1rem', alignItems: 'center'}}>
                <div>
                  <div style={{fontWeight: 600}}>{parent.email}</div>
                  <div style={{fontSize: '0.8rem', opacity: 0.8}}>
                    {parent.active ? 'Aktywne' : 'Nieaktywne'} • {(parent.createdAt || '').slice(0, 10)}
                    {parent.id === user?.id ? ' • Twoje konto' : ''}
                  </div>
                </div>
                <button
                  className={parent.active ? 'btn btn-danger' : 'btn btn-success'}
                  onClick={() => onToggleParent(parent.id, !parent.active)}
                >
                  {parent.active ? 'Dezaktywuj' : 'Aktywuj'}
                </button>
              </div>
            </div>
          ))}
          
          <h4 style={{marginBottom: '0.5rem', marginTop: '1rem'}}>Zmień PIN</h4>
          <input className="input" placeholder="Nowy PIN (4 cyfry)" value={pinCode} onChange={e => setPinCode(e.target.value.replace(/\D/g, '').slice(0, 4))} />
          <button
            className="btn btn-secondary"
            style={{width: '100%', marginBottom: '1rem'}}
            onClick={async () => {
              try {
                await onChangePin(pinCode);
                setPinCode('');
                setMessage('PIN został zmieniony.');
              } catch (e) {
                setMessage(e.message);
              }
            }}
          >
            Zapisz PIN
          </button>
          
          <h4 style={{marginBottom: '0.5rem'}}>Zmień hasło</h4>
          <input className="input" type="password" placeholder="Aktualne hasło" value={currentPassword} onChange={e => setCurrentPassword(e.target.value)} />
          <input className="input" type="password" placeholder="Nowe hasło" value={newPassword} onChange={e => setNewPassword(e.target.value)} />
          <button
            className="btn btn-secondary"
            style={{width: '100%', marginBottom: '1rem'}}
            onClick={async () => {
              try {
                await onChangePassword(currentPassword, newPassword);
                setCurrentPassword('');
                setNewPassword('');
                setMessage('Hasło zostało zmienione.');
              } catch (e) {
                setMessage(e.message);
              }
            }}
          >
            Zmień hasło
          </button>
          
          <h4 style={{marginBottom: '0.5rem'}}>Reset hasła użytkownika</h4>
          <select className="select" value={resetTarget} onChange={e => setResetTarget(e.target.value)}>
            <option value="">Wybierz konto</option>
            {parentUsers.map(parent => (
              <option key={parent.id} value={parent.id}>{parent.email}</option>
            ))}
          </select>
          <input className="input" type="password" placeholder="Nowe hasło dla wybranego konta" value={resetPasswordValue} onChange={e => setResetPasswordValue(e.target.value)} />
          <button
            className="btn btn-secondary"
            style={{width: '100%'}}
            onClick={async () => {
              try {
                if (!resetTarget) throw new Error('Wybierz konto do resetu');
                await onResetPassword(resetTarget, resetPasswordValue);
                setResetPasswordValue('');
                setMessage('Hasło użytkownika zostało zresetowane.');
              } catch (e) {
                setMessage(e.message);
              }
            }}
          >
            Resetuj hasło
          </button>
        </div>
      );
    };
    
    const SettingsBackupPanel = ({ familyGoal, onFamilyGoalChange, onExport, onImport }) => {
      const [title, setTitle] = useState(familyGoal?.title || 'Cel rodzinny');
      const [target, setTarget] = useState(String(familyGoal?.target || 500));
      const [mode, setMode] = useState(familyGoal?.mode || 'points');
      const [message, setMessage] = useState('');
      
      return (
        <div className="glass-card">
          <h3 style={{marginBottom: '0.75rem'}}>🧰 Backup i cel rodzinny</h3>
          {message && <div className="success">{message}</div>}
          
          <h4 style={{marginBottom: '0.5rem'}}>Cel rodzinny</h4>
          <input className="input" placeholder="Nazwa celu" value={title} onChange={e => setTitle(e.target.value)} />
          <input className="input" type="number" min="1" placeholder="Próg" value={target} onChange={e => setTarget(e.target.value)} />
          <select className="select" value={mode} onChange={e => setMode(e.target.value)}>
            <option value="points">Suma punktów rodziny</option>
            <option value="passedDays">Liczba zaliczonych dni rodziny</option>
          </select>
          <button
            className="btn btn-primary"
            style={{width: '100%', marginBottom: '1rem'}}
            onClick={() => {
              onFamilyGoalChange({
                title: title.trim() || 'Cel rodzinny',
                target: Math.max(1, parseInt(target || '1', 10)),
                mode,
              });
              setMessage('Cel rodzinny został zapisany.');
            }}
          >
            Zapisz cel
          </button>
          
          <h4 style={{marginBottom: '0.5rem'}}>Backup</h4>
          <div style={{display: 'flex', gap: '0.5rem'}}>
            <button className="btn btn-secondary" style={{flex: 1}} onClick={onExport}>
              Eksport JSON
            </button>
            <label className="btn btn-secondary" style={{flex: 1, textAlign: 'center'}}>
              Import JSON
              <input
                type="file"
                accept="application/json"
                style={{display: 'none'}}
                onChange={async (e) => {
                  const file = e.target.files?.[0];
                  if (!file) return;
                  const text = await file.text();
                  try {
                    onImport(text);
                    setMessage('Backup został zaimportowany.');
                  } catch (err) {
                    setMessage('Import nieudany: ' + err.message);
                  }
                  e.target.value = '';
                }}
              />
            </label>
          </div>
        </div>
      );
    };
    
    // Login View Component
    const LoginView = ({ onLogin, onRegister, onChildLogin, onForgotPassword, onResetPassword }) => {
      const [mode, setMode] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [familyName, setFamilyName] = useState('');
      const [pinCode, setPinCode] = useState('');
      const [childCode, setChildCode] = useState('');
      const [resetToken, setResetToken] = useState('');
      const [success, setSuccess] = useState('');
      const [error, setError] = useState('');
      const [submitting, setSubmitting] = useState(false);

      const switchMode = (nextMode) => {
        setMode(nextMode);
        setError('');
        setSuccess('');
      };

      const getSubtitle = () => {
        if (mode === 'register') return 'Załóż konto rodzica';
        if (mode === 'child') return 'Zaloguj dziecko kodem dostępu';
        if (mode === 'forgot') return 'Reset hasła rodzica';
        if (mode === 'reset') return 'Ustaw nowe hasło';
        return 'Zaloguj się do konta rodzica';
      };

      const getSubmitLabel = () => {
        if (mode === 'register') return 'Utwórz konto';
        if (mode === 'child') return 'Zaloguj dziecko';
        if (mode === 'forgot') return 'Wyślij reset';
        if (mode === 'reset') return 'Zmień hasło';
        return 'Zaloguj się';
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        setSubmitting(true);

        let result = null;
        if (mode === 'login') {
          result = await onLogin(email, password);
        } else if (mode === 'register') {
          result = await onRegister({ email, password, pinCode, familyName });
        } else if (mode === 'child') {
          result = await onChildLogin(childCode);
        } else if (mode === 'forgot') {
          result = await onForgotPassword(email);
        } else {
          result = await onResetPassword(resetToken, password);
        }

        if (!result?.success) {
          setError(result?.error || 'Operacja nie powiodła się');
          setSubmitting(false);
          return;
        }

        if (mode === 'forgot') {
          const debugTokenText = result.debugResetToken ? ` Token testowy: ${result.debugResetToken}` : '';
          setSuccess((result.message || 'Wysłano instrukcję resetu.') + debugTokenText);
          if (result.debugResetToken) setResetToken(result.debugResetToken);
          setMode('reset');
        } else if (mode === 'reset') {
          setSuccess(result.message || 'Hasło zostało zmienione.');
          setPassword('');
          setResetToken('');
          setMode('login');
        }

        setSubmitting(false);
      };
      
      return (
        <div className="app-container">
          <div className="glass-card" style={{maxWidth: '560px', margin: '5rem auto'}}>
            <div style={{textAlign: 'center', marginBottom: '1.2rem'}}>
              <div style={{fontSize: '5rem'}}>🏆</div>
              <h1>FamilyQuest</h1>
              <p style={{opacity: 0.8}}>{getSubtitle()}</p>
            </div>

            <div className="tabs" style={{justifyContent: 'center', marginBottom: '1rem'}}>
              <button className={`tab ${mode === 'login' ? 'active' : ''}`} onClick={() => switchMode('login')}>
                Rodzic
              </button>
              <button className={`tab ${mode === 'register' ? 'active' : ''}`} onClick={() => switchMode('register')}>
                Rejestracja
              </button>
              <button className={`tab ${mode === 'child' ? 'active' : ''}`} onClick={() => switchMode('child')}>
                Dziecko
              </button>
              <button className={`tab ${mode === 'forgot' ? 'active' : ''}`} onClick={() => switchMode('forgot')}>
                Reset
              </button>
            </div>
            
            <form onSubmit={handleSubmit}>
              {error && <div className="error">{error}</div>}
              {success && <div className="success">{success}</div>}

              {(mode === 'login' || mode === 'register' || mode === 'forgot') && (
                <input
                  type="email"
                  className="input"
                  placeholder="Email rodzica"
                  value={email}
                  onChange={e => setEmail(e.target.value)}
                  required
                />
              )}

              {(mode === 'login' || mode === 'register' || mode === 'reset') && (
                <input
                  type="password"
                  className="input"
                  placeholder={mode === 'reset' ? 'Nowe hasło' : 'Hasło'}
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  required
                />
              )}

              {mode === 'register' && (
                <>
                  <input
                    type="text"
                    className="input"
                    placeholder="Nazwa rodziny (np. Rodzina Kowalskich)"
                    value={familyName}
                    onChange={e => setFamilyName(e.target.value)}
                  />
                  
                  <input
                    type="text"
                    className="input"
                    placeholder="PIN rodzica (4 cyfry)"
                    value={pinCode}
                    onChange={e => setPinCode(e.target.value.replace(/\D/g, '').slice(0, 4))}
                    inputMode="numeric"
                    maxLength={4}
                    required
                  />
                </>
              )}

              {mode === 'child' && (
                <input
                  type="text"
                  className="input"
                  placeholder="Kod dziecka (4 cyfry)"
                  value={childCode}
                  onChange={e => setChildCode(e.target.value.replace(/\D/g, '').slice(0, 4))}
                  inputMode="numeric"
                  maxLength={4}
                  required
                />
              )}

              {mode === 'reset' && (
                <input
                  type="text"
                  className="input"
                  placeholder="Token resetu"
                  value={resetToken}
                  onChange={e => setResetToken(e.target.value)}
                  required
                />
              )}
              
              <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={submitting}>
                {submitting ? 'Przetwarzanie...' : getSubmitLabel()}
              </button>
            </form>
          </div>
        </div>
      );
    };
    
    // Child Selection View Component
    const ChildSelectionView = ({ children, onSelectChild, onParentMode, onLogout, parentPin }) => {
      const [showPinModal, setShowPinModal] = useState(false);
      
      return (
        <div className="app-container">
          <div className="glass-card">
            <div className="header">
              <button className="btn btn-danger" onClick={onLogout}>Wyloguj</button>
              <h1>Wybierz profil</h1>
              <button className="btn btn-secondary" onClick={() => setShowPinModal(true)}>
                🔐 Panel rodzica
              </button>
            </div>
            
            {children.length === 0 ? (
              <div className="empty-state">
                <div style={{fontSize: '5rem'}}>👨‍👩‍👧‍👦</div>
                <p>Brak dzieci. Przejdź do panelu rodzica, aby dodać pierwsze dziecko.</p>
              </div>
            ) : (
              <div className="grid grid-3">
                {children.map(child => (
                  <div key={child.id} className="glass-card child-card" onClick={() => onSelectChild(child)}>
                    <div className="child-avatar">{child.avatar}</div>
                    <h2 style={{textAlign: 'center'}}>{child.name}</h2>
                  </div>
                ))}
              </div>
            )}
          </div>
          
          {showPinModal && (
            <PinModal 
              parentPin={parentPin}
              onSuccess={onParentMode} 
              onClose={() => setShowPinModal(false)} 
            />
          )}
        </div>
      );
    };
    
    // PIN Modal Component
    const PinModal = ({ parentPin, onSuccess, onClose }) => {
      const [pin, setPin] = useState('');
      const [error, setError] = useState('');
      
      const handlePinClick = (digit) => {
        const newPin = pin + digit;
        setPin(newPin);
        
        if (newPin.length === 4) {
          if (newPin === parentPin) {
            onSuccess();
          } else {
            setError('Nieprawidłowy PIN');
            setPin('');
          }
        }
      };
      
      return (
        <div className="modal">
          <div className="modal-content" style={{maxWidth: '400px', textAlign: 'center'}}>
            <h2 style={{marginBottom: '1.5rem'}}>🔒 Wprowadź PIN rodzica</h2>
            
            <div style={{display: 'flex', justifyContent: 'center', gap: '1rem', marginBottom: '1.5rem'}}>
              {[0, 1, 2, 3].map(i => (
                <div key={i} style={{
                  width: '20px',
                  height: '20px',
                  borderRadius: '50%',
                  background: i < pin.length ? '#FEC84B' : 'rgba(255, 255, 255, 0.3)',
                  border: '2px solid rgba(255, 255, 255, 0.5)'
                }} />
              ))}
            </div>
            
            {error && <div className="error">{error}</div>}
            
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem', marginBottom: '1rem'}}>
              {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                <button 
                  key={num} 
                  className="btn btn-secondary" 
                  onClick={() => handlePinClick(num.toString())}
                  style={{fontSize: '1.5rem', padding: '1.5rem'}}
                >
                  {num}
                </button>
              ))}
              <button className="btn btn-danger" onClick={onClose}>✕</button>
              <button className="btn btn-secondary" onClick={() => handlePinClick('0')} style={{fontSize: '1.5rem', padding: '1.5rem'}}>
                0
              </button>
              <button className="btn btn-secondary" onClick={() => setPin(pin.slice(0, -1))}>⌫</button>
            </div>
            
            {!parentPin && (
              <div style={{fontSize: '0.85rem', opacity: 0.7, marginTop: '1rem'}}>
                PIN rodzica nie jest ustawiony. Zaloguj się ponownie.
              </div>
            )}
          </div>
        </div>
      );
    };
    
    // Add Child Modal Component
    const AddChildModal = ({ onAdd, onClose }) => {
      const [name, setName] = useState('');
      const [avatar, setAvatar] = useState('👧');
      const [customAvatar, setCustomAvatar] = useState('');
      const [activeDays, setActiveDays] = useState([1, 2, 3, 4, 5]);
      const [error, setError] = useState('');
      
      const toggleDay = (day) => {
        if (activeDays.includes(day)) {
          setActiveDays(activeDays.filter(d => d !== day));
        } else {
          setActiveDays([...activeDays, day].sort((a, b) => a - b));
        }
      };
      
      const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        const normalizedName = name.trim();
        const normalizedAvatar = (customAvatar.trim() || avatar || '').trim();
        if (!normalizedName) {
          setError('Imię dziecka jest wymagane.');
          return;
        }
        if (!normalizedAvatar) {
          setError('Wybierz avatar dziecka.');
          return;
        }
        if (activeDays.length === 0) {
          setError('Wybierz co najmniej 1 dzień aktywny.');
          return;
        }
        onAdd(normalizedName, normalizedAvatar, activeDays);
      };
      
      return (
        <div className="modal">
          <div className="modal-content">
            <h2 style={{marginBottom: '1.5rem'}}>Dodaj dziecko</h2>
            
            <form onSubmit={handleSubmit}>
              {error && <div className="error">{error}</div>}
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Imię</label>
              <input
                type="text"
                className="input"
                value={name}
                onChange={e => setName(e.target.value)}
                required
                placeholder="Wpisz imię dziecka"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Wybierz avatar</label>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '0.5rem', marginBottom: '1rem'}}>
                {CHILD_AVATARS.map(av => (
                  <button
                    key={av}
                    type="button"
                    onClick={() => {
                      setAvatar(av);
                      setCustomAvatar('');
                    }}
                    style={{
                      fontSize: '2rem',
                      padding: '0.5rem',
                      background: customAvatar ? 'rgba(255, 255, 255, 0.1)' : (avatar === av ? 'rgba(254, 200, 75, 0.3)' : 'rgba(255, 255, 255, 0.1)'),
                      border: customAvatar ? '2px solid transparent' : (avatar === av ? '2px solid #FEC84B' : '2px solid transparent'),
                      borderRadius: '1rem',
                      cursor: 'pointer'
                    }}
                  >
                    {av}
                  </button>
                ))}
              </div>

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Własny avatar (emoji)</label>
              <input
                type="text"
                className="input"
                value={customAvatar}
                onChange={e => setCustomAvatar(e.target.value)}
                placeholder="np. 🤖"
              />
              <div style={{fontSize: '0.9rem', opacity: 0.85, marginBottom: '1rem'}}>
                Wybrany avatar: <strong>{customAvatar.trim() || avatar}</strong>
              </div>
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Dni aktywne</label>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', marginBottom: '1.5rem'}}>
                {DAY_NAMES.map((day, index) => {
                  const dayNum = index + 1;
                  return (
                    <button
                      key={dayNum}
                      type="button"
                      onClick={() => toggleDay(dayNum)}
                      style={{
                        padding: '0.75rem 0.5rem',
                        background: activeDays.includes(dayNum) ? 'rgba(18, 183, 106, 0.3)' : 'rgba(255, 255, 255, 0.1)',
                        border: activeDays.includes(dayNum) ? '2px solid #12B76A' : '2px solid transparent',
                        borderRadius: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.85rem',
                        fontWeight: 600,
                        color: 'white'
                      }}
                    >
                      {day}
                    </button>
                  );
                })}
              </div>
              
              <div style={{display: 'flex', gap: '1rem'}}>
                <button type="button" className="btn btn-secondary" onClick={onClose} style={{flex: 1}}>
                  Anuluj
                </button>
                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                  Dodaj dziecko
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Edit Child Modal Component
    const EditChildModal = ({ child, siblings, onSave, onClose }) => {
      const [name, setName] = useState(child?.name || '');
      const [avatar, setAvatar] = useState(child?.avatar || '👧');
      const [customAvatar, setCustomAvatar] = useState('');
      const [activeDays, setActiveDays] = useState(Array.isArray(child?.activeDays) ? child.activeDays : [1, 2, 3, 4, 5]);
      const [accessCode, setAccessCode] = useState(child?.accessCode || '');
      const [error, setError] = useState('');

      const toggleDay = (day) => {
        if (activeDays.includes(day)) {
          setActiveDays(activeDays.filter(d => d !== day));
        } else {
          setActiveDays([...activeDays, day].sort((a, b) => a - b));
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        setError('');

        const normalizedName = name.trim();
        const normalizedAvatar = (customAvatar.trim() || avatar || '').trim();
        const normalizedCode = accessCode.replace(/\D/g, '').slice(0, 4);

        if (!normalizedName) {
          setError('Imię dziecka jest wymagane.');
          return;
        }
        if (!normalizedAvatar) {
          setError('Wybierz avatar dziecka.');
          return;
        }
        if (activeDays.length === 0) {
          setError('Wybierz co najmniej 1 dzień aktywny.');
          return;
        }
        if (!isValidChildAccessCode(normalizedCode)) {
          setError('Kod dziecka musi mieć dokładnie 4 cyfry.');
          return;
        }

        const uniqueCode = findAvailableChildAccessCode(siblings, normalizedCode, child.id);
        if (!uniqueCode) {
          setError('Nie udało się ustawić unikalnego kodu dziecka.');
          return;
        }

        onSave({
          name: normalizedName,
          avatar: normalizedAvatar,
          activeDays: [...new Set(activeDays)].sort((a, b) => a - b),
          accessCode: uniqueCode,
        });
      };

      return (
        <div className="modal">
          <div className="modal-content">
            <h2 style={{marginBottom: '1.5rem'}}>Edytuj profil dziecka</h2>

            <form onSubmit={handleSubmit}>
              {error && <div className="error">{error}</div>}

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Imię</label>
              <input
                type="text"
                className="input"
                value={name}
                onChange={e => setName(e.target.value)}
                required
              />

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Wybierz avatar</label>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '0.5rem', marginBottom: '1rem'}}>
                {CHILD_AVATARS.map(av => (
                  <button
                    key={av}
                    type="button"
                    onClick={() => {
                      setAvatar(av);
                      setCustomAvatar('');
                    }}
                    style={{
                      fontSize: '2rem',
                      padding: '0.5rem',
                      background: customAvatar ? 'rgba(255, 255, 255, 0.1)' : (avatar === av ? 'rgba(254, 200, 75, 0.3)' : 'rgba(255, 255, 255, 0.1)'),
                      border: customAvatar ? '2px solid transparent' : (avatar === av ? '2px solid #FEC84B' : '2px solid transparent'),
                      borderRadius: '1rem',
                      cursor: 'pointer',
                    }}
                  >
                    {av}
                  </button>
                ))}
              </div>

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Własny avatar (emoji)</label>
              <input
                type="text"
                className="input"
                value={customAvatar}
                onChange={e => setCustomAvatar(e.target.value)}
                placeholder="np. 🤖"
              />
              <div style={{fontSize: '0.9rem', opacity: 0.85, marginBottom: '1rem'}}>
                Wybrany avatar: <strong>{customAvatar.trim() || avatar}</strong>
              </div>

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Kod dziecka (4 cyfry)</label>
              <input
                type="text"
                className="input"
                value={accessCode}
                onChange={e => setAccessCode(e.target.value.replace(/\D/g, '').slice(0, 4))}
                inputMode="numeric"
                maxLength={4}
                required
              />

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Dni aktywne</label>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', marginBottom: '1.5rem'}}>
                {DAY_NAMES.map((day, index) => {
                  const dayNum = index + 1;
                  return (
                    <button
                      key={dayNum}
                      type="button"
                      onClick={() => toggleDay(dayNum)}
                      style={{
                        padding: '0.75rem 0.5rem',
                        background: activeDays.includes(dayNum) ? 'rgba(18, 183, 106, 0.3)' : 'rgba(255, 255, 255, 0.1)',
                        border: activeDays.includes(dayNum) ? '2px solid #12B76A' : '2px solid transparent',
                        borderRadius: '0.5rem',
                        cursor: 'pointer',
                        fontSize: '0.85rem',
                        fontWeight: 600,
                        color: 'white',
                      }}
                    >
                      {day}
                    </button>
                  );
                })}
              </div>

              <div style={{display: 'flex', gap: '1rem'}}>
                <button type="button" className="btn btn-secondary" onClick={onClose} style={{flex: 1}}>
                  Anuluj
                </button>
                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                  Zapisz zmiany
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    // Add Task Modal Component
    const AddTaskModal = ({ children, onAdd, onClose }) => {
      const [childId, setChildId] = useState(children[0]?.id || '');
      const [title, setTitle] = useState('');
      const [tier, setTier] = useState('MIN');
      const [points, setPoints] = useState(0);
      const [description, setDescription] = useState('');
      const [templateId, setTemplateId] = useState('');

      const templatesForTier = TASK_TEMPLATES.filter(t => t.tier === tier);
      const applyTemplate = (id) => {
        const template = TASK_TEMPLATES.find(t => t.id === id);
        if (!template) return;
        setTemplateId(template.id);
        setTier(template.tier);
        setTitle(template.title);
        setPoints(template.points);
        setDescription(template.description || '');
      };
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onAdd(childId, title, tier, points, description);
      };
      
      return (
        <div className="modal">
          <div className="modal-content">
            <h2 style={{marginBottom: '1.5rem'}}>Dodaj zadanie</h2>
            
            <form onSubmit={handleSubmit}>
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Dziecko</label>
              <select className="select" value={childId} onChange={e => setChildId(e.target.value)} required>
                {children.map(child => (
                  <option key={child.id} value={child.id}>{child.avatar} {child.name}</option>
                ))}
              </select>
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Tytuł zadania</label>
              <input
                type="text"
                className="input"
                value={title}
                onChange={e => setTitle(e.target.value)}
                required
                placeholder="np. Pościel łóżko"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Typ zadania</label>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '0.5rem', marginBottom: '1rem'}}>
                {['MIN', 'PLUS', 'WEEKLY'].map(t => (
                  <button
                    key={t}
                    type="button"
                    onClick={() => {
                      setTier(t);
                      setTemplateId('');
                    }}
                    className={`badge badge-${t.toLowerCase()}`}
                    style={{
                      padding: '1rem',
                      opacity: tier === t ? 1 : 0.5,
                      border: tier === t ? '2px solid white' : '2px solid transparent',
                      cursor: 'pointer'
                    }}
                  >
                    {t === 'MIN' ? '📋 MINIMUM' : t === 'PLUS' ? '⭐ BONUS' : '📅 TYGODNIOWE'}
                  </button>
                ))}
              </div>

              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Szablon (opcjonalnie)</label>
              <select
                className="select"
                value={templateId}
                onChange={e => applyTemplate(e.target.value)}
              >
                <option value="">Własne zadanie</option>
                {templatesForTier.map(template => (
                  <option key={template.id} value={template.id}>
                    {template.title} (+{template.points} pkt)
                  </option>
                ))}
              </select>
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Punkty (opcjonalne)</label>
              <input
                type="number"
                className="input"
                value={points}
                onChange={e => setPoints(parseInt(e.target.value) || 0)}
                min="0"
                placeholder="0"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Opis (opcjonalny)</label>
              <textarea
                className="textarea"
                value={description}
                onChange={e => setDescription(e.target.value)}
                placeholder="np. Zaraz po wstaniu"
                rows="2"
              />
              
              <div style={{display: 'flex', gap: '1rem'}}>
                <button type="button" className="btn btn-secondary" onClick={onClose} style={{flex: 1}}>
                  Anuluj
                </button>
                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                  Dodaj zadanie
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    // Add Reward Modal Component
    const AddRewardModal = ({ onAdd, onClose }) => {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [requiredPoints, setRequiredPoints] = useState('');
      const [requiredStreak, setRequiredStreak] = useState('');
      const [requiredIdealWeeks, setRequiredIdealWeeks] = useState('');
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onAdd(
          title, 
          description, 
          requiredPoints ? parseInt(requiredPoints) : null,
          requiredStreak ? parseInt(requiredStreak) : null,
          requiredIdealWeeks ? parseInt(requiredIdealWeeks) : null
        );
      };
      
      return (
        <div className="modal">
          <div className="modal-content">
            <h2 style={{marginBottom: '1.5rem'}}>Dodaj nagrodę</h2>
            
            <form onSubmit={handleSubmit}>
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Nazwa nagrody</label>
              <input
                type="text"
                className="input"
                value={title}
                onChange={e => setTitle(e.target.value)}
                required
                placeholder="np. 30 minut gier"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Opis</label>
              <textarea
                className="textarea"
                value={description}
                onChange={e => setDescription(e.target.value)}
                placeholder="np. Dodatkowy czas na granie"
                rows="2"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Wymagane punkty (opcjonalne)</label>
              <input
                type="number"
                className="input"
                value={requiredPoints}
                onChange={e => setRequiredPoints(e.target.value)}
                min="0"
                placeholder="np. 50"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Wymagana passa (dni z rzędu, opcjonalne)</label>
              <input
                type="number"
                className="input"
                value={requiredStreak}
                onChange={e => setRequiredStreak(e.target.value)}
                min="0"
                placeholder="np. 7"
              />
              
              <label style={{display: 'block', marginBottom: '0.5rem', opacity: 0.8}}>Wymagane idealne tygodnie z rzędu (opcjonalne)</label>
              <input
                type="number"
                className="input"
                value={requiredIdealWeeks}
                onChange={e => setRequiredIdealWeeks(e.target.value)}
                min="0"
                placeholder="np. 2"
              />
              
              <div style={{display: 'flex', gap: '1rem'}}>
                <button type="button" className="btn btn-secondary" onClick={onClose} style={{flex: 1}}>
                  Anuluj
                </button>
                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                  Dodaj nagrodę
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Render
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(err => {
          console.warn('Service worker registration failed:', err);
        });
      });
    }
    
    console.log('🏆 FamilyQuest - Pełna wersja produkcyjna');
    console.log('✨ Funkcje: konto rodzica, Postgres, zarządzanie dziećmi i zadaniami, passa, punkty, ranking, nagrody');
  </script>
</body>
</html>
